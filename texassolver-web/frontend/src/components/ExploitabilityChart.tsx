import {
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip,
  ResponsiveContainer, ReferenceLine,
} from 'recharts';
import { parseExploitability } from '../lib/strategyUtils';

interface Props {
  progressLines: string[];
  targetAccuracy?: number;
}

export default function ExploitabilityChart({ progressLines, targetAccuracy }: Props) {
  const data = parseExploitability(progressLines);

  if (data.length === 0) {
    return (
      <div style={{
        height: 120, display: 'flex', alignItems: 'center', justifyContent: 'center',
        color: 'var(--text-muted)', fontSize: '12px',
      }}>
        No exploitability data yetâ€¦
      </div>
    );
  }

  const latest = data[data.length - 1];
  const first  = data[0];
  const improvement = first.exploitability > 0
    ? ((first.exploitability - latest.exploitability) / first.exploitability * 100).toFixed(0)
    : '0';

  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
      {/* Stats row */}
      <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
        <Stat label="Latest" value={`${latest.exploitability.toFixed(2)}%`} color="var(--accent-text)" />
        <Stat label="Iteration" value={String(latest.iter)} color="var(--text-primary)" />
        <Stat label="Improved" value={`${improvement}%`} color="var(--info)" />
        {first.exploitability > 0 && (
          <Stat label="Started at" value={`${first.exploitability.toFixed(1)}%`} color="var(--text-secondary)" />
        )}
      </div>

      {/* Chart */}
      <div style={{ height: 180 }}>
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data} margin={{ top: 4, right: 8, left: -20, bottom: 0 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="var(--border)" strokeOpacity={0.5} />
            <XAxis
              dataKey="iter"
              tick={{ fontSize: 10, fill: 'var(--text-muted)' }}
              label={{ value: 'Iteration', position: 'insideBottom', offset: -2, fontSize: 10, fill: 'var(--text-muted)' }}
            />
            <YAxis
              tick={{ fontSize: 10, fill: 'var(--text-muted)' }}
              tickFormatter={v => `${v.toFixed(0)}%`}
            />
            <Tooltip
              contentStyle={{
                background: 'var(--bg-elevated)',
                border: '1px solid var(--border)',
                borderRadius: '8px',
                fontSize: '11px',
                color: 'var(--text-primary)',
              }}
              formatter={(value: number | undefined) => [`${(value ?? 0).toFixed(3)}%`, 'Exploitability']}
              labelFormatter={l => `Iter ${l}`}
            />
            {targetAccuracy !== undefined && (
              <ReferenceLine
                y={targetAccuracy}
                stroke="var(--warning)"
                strokeDasharray="4 4"
                label={{ value: 'Target', fill: 'var(--warning)', fontSize: 10 }}
              />
            )}
            <Line
              type="monotone"
              dataKey="exploitability"
              stroke="var(--accent)"
              strokeWidth={2}
              dot={data.length <= 20}
              activeDot={{ r: 4, fill: 'var(--accent)' }}
              isAnimationActive={false}
            />
          </LineChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}

function Stat({ label, value, color }: { label: string; value: string; color: string }) {
  return (
    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
      <div style={{ fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', fontWeight: 600 }}>{label}</div>
      <div style={{ fontSize: '16px', fontWeight: 800, color, lineHeight: 1 }}>{value}</div>
    </div>
  );
}
